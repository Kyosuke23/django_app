{% extends "layout/base.html" %}
{% load django_bootstrap5 %}
{% load static %}
{% load humanize %}
{% block content %}

<form id="search_form" method="get" action="{% url 'product_mst:list' %}">
  {# タイトル・操作ボタン #}
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2 mb-0"><i class="bi bi-box-seam me-2"></i> 商品マスタ管理</h1>

    <div class="d-flex gap-2">
      <input type="file" id="file-input" name="file" accept=".csv" class="d-none">
      <button type="button" id="import-btn" class="btn btn-outline-secondary btn-sm"
              data-action="{% url 'product_mst:import_csv' %}">
        <i class="bi bi-upload"></i> Import
      </button>
      <button type="button" class="btn btn-outline-secondary btn-sm export-btn"
              data-action="{% url 'product_mst:export_csv' %}">
        <i class="bi bi-download"></i> Export
      </button>
      {% if user.privilege <= PRIVILEGE_MANAGER %}
      <a class="btn btn-outline-primary btn-sm"
         href="#"
         data-bs-toggle="modal"
         data-bs-target="#productModal"
         data-url="{% url 'product_mst:create' %}">
         <i class="bi bi-plus-circle"></i> 新規登録
      </a>
      {% endif %}
    </div>
  </div>

  {% include 'layout/message.html' %}

  {# 検索フォーム #}
  <div class="card shadow-sm border-0 mb-3">
    <div class="card-body pb-2">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="card-title mb-0"><i class="bi bi-search me-2 text-primary"></i>検索条件</h5>
      </div>

      {# 基本検索 #}
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label small text-muted">キーワード検索</label>
          <div class="input-group input-group-sm">
            <input type="text" name="search_keyword" class="form-control"
                   value="{{ search_keyword }}" placeholder="キーワードを入力">
            <button type="submit" class="btn btn-primary">
              <i class="bi bi-search"></i>
            </button>
          </div>
        </div>

        <div class="col-md-2 text-start">
          <button class="btn btn-outline-secondary btn-sm" type="button"
                  data-bs-toggle="collapse" data-bs-target="#detailSearch"
                  aria-expanded="false" aria-controls="detailSearch">
            <i class="bi bi-funnel"></i> 詳細検索
          </button>
          <a href="{% url 'product_mst:list' %}" class="btn btn-link btn-sm text-muted">
            <i class="bi bi-arrow-counterclockwise"></i> リセット
          </a>
        </div>
      </div>

      {# 詳細検索 #}
      <div class="collapse mt-3" id="detailSearch">
        <hr class="text-muted">
        <div class="row g-3">
          <div class="col-md-2">
            <label class="form-label small text-muted">商品名</label>
            <input type="text" name="search_unit" class="form-control form-control-sm"
                   value="{{ search_unit }}" placeholder="商品名">
          </div>

          <div class="col-md-1">
            <label class="form-label small text-muted">カテゴリ</label>
            <select id="search_product_category" name="search_product_category" class="form-select form-select-sm">
              <option value="">すべて</option>
              {% for cat in categories %}
                <option value="{{ cat.id }}" {% if search_product_category == cat.id|stringformat:"s" %}selected{% endif %}>
                  {{ cat.product_category_name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label small text-muted">単価（下限〜上限）</label>
            <div class="input-group input-group-sm">
              <input type="number" name="search_unit_price_min" class="form-control" value="{{ search_unit_price_min }}" placeholder="下限">
              <span class="input-group-text">〜</span>
              <input type="number" name="search_unit_price_max" class="form-control" value="{{ search_unit_price_max }}" placeholder="上限">
            </div>
          </div>

          <div class="col-md-1">
            <label class="form-label small text-muted">単位</label>
            <input type="text" name="search_unit" class="form-control form-control-sm"
                   value="{{ search_unit }}" placeholder="例：個、箱、kgなど">
          </div>
        </div>
      </div>
    </div>
  </div>
</form>
{# カテゴリ管理 #}
<div class="card mt-4 border-0 shadow-sm mb-3">
  <div class="card-header bg-secondary-subtle border-bottom fw-bold text-dark">
    <a class="text-decoration-none text-dark d-block" 
      data-bs-toggle="collapse" href="#categoryArea" role="button"
      aria-expanded="false" aria-controls="categoryArea">
      <i class="bi bi-tags-fill me-1 text-primary"></i> 商品カテゴリ管理（クリックで開閉）
    </a>
  </div>
  <div class="collapse {% if request.GET.category_open %}show{% endif %}" id="categoryArea">
    <div class="card-body">
      <form method="post" action="{% url 'product_mst:category_save' %}">
        {% csrf_token %}
        <div class="row g-2 mb-2">
          <div class="col-auto">
            <select id="categoryId" name="category_id" class="form-select form-select-sm">
              <option value="">--- 新規作成 ---</option>
              {% for c in categories %}
                <option value="{{ c.id }}">{{ c.product_category_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col">
            <input type="text" id="categoryName" name="category_name"
                   class="form-control form-control-sm" placeholder="カテゴリ名を入力">
          </div>
        </div>

        <div class="d-flex">
          <button type="submit" name="action" value="save" class="btn btn-outline-primary btn-sm">
            保存
          </button>
          <button type="submit" name="action" value="delete" class="btn btn-outline-danger btn-sm ms-2">
            削除
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{# 件数表示 + 並び替え #}
<div class="d-flex justify-content-between align-items-center mb-2 mt-2">
  <p class="text-muted small mb-0">
    {{ paginator.count }}件中 {{ page_obj.start_index }}〜{{ page_obj.end_index }}件を表示
  </p>

  {# 並び替えドロップダウン #}
  <div class="d-flex align-items-center gap-2">
    <select id="form-select" name="sort" class="form-select form-select-sm">
      <option value="">並び替え</option>
      <optgroup label="単価">
        <option value="unit_price" {% if request.GET.sort == 'unit_price' %}selected{% endif %}>
          単価：昇順 ▲
        </option>
        <option value="-unit_price" {% if request.GET.sort == '-unit_price' %}selected{% endif %}>
          単価：降順 ▼
        </option>
      </optgroup>
    </select>
  </div>
</div>

{# 商品テーブル #}
<div class="table-responsive border rounded shadow-sm bg-white">
  <form id="bulk-delete-form" method="post" action="{% url 'product_mst:bulk_delete' %}">
    {% csrf_token %}
    <table class="table table-hover align-middle mb-0">
      <thead class="table-dark">
        <tr>
          {% if user.privilege <= PRIVILEGE_MANAGER %}
          <th class="text-center"><input type="checkbox" id="check-all"></th>
          {% endif %}
          <th>商品名称</th>
          <th>カテゴリ</th>
          <th>単価</th>
          <th>単位</th>
          <th>説明文</th>
          {% if user.privilege <= PRIVILEGE_MANAGER %}
          <th>操作</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for product in products %}
        <tr>
          {% if user.privilege <= PRIVILEGE_MANAGER %}
          <td class="text-center"><input type="checkbox" name="ids" value="{{ product.id }}"></td>
          {% endif %}
          <td>{{ product.product_name|default_if_none:'' }}</td>
          <td>{{ product.product_category.product_category_name|default_if_none:'' }}</td>
          <td>{% if product.unit_price %}¥{% endif %}{{ product.unit_price|default_if_none:''|intcomma }}</td>
          <td>{{ product.unit|default_if_none:'' }}</td>
          <td>{{ product.description|default_if_none:'' }}</td>
          {% if user.privilege <= PRIVILEGE_MANAGER %}
          <td>
            <a href="#" class="btn btn-sm btn-outline-secondary"
               data-bs-toggle="modal"
               data-bs-target="#productModal"
               data-url="{% url 'product_mst:update' product.id %}">
              <i class="bi bi-pencil"></i> 編集
            </a>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>
</div>

{# ページネーション & 一括削除 #}
<div class="d-flex justify-content-between align-items-center mt-3">
  <div>{% include 'layout/pagination.html' %}</div>
  {% if user.privilege <= PRIVILEGE_MANAGER %}
  <div>
    <button type="button" id="bulk-delete-btn" class="btn btn-danger btn-sm"
            data-url="{% url 'product_mst:bulk_delete' %}">
      <i class="bi bi-trash3"></i> 一括削除
    </button>
  </div>
  {% endif %}
</div>

{# モーダル #}
<div class="modal fade" id="productModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body">{# Ajaxでフォームをロード #}</div>
    </div>
  </div>
</div>

<script src="{% static 'js/product_mst/script.js' %}"></script>
{% endblock %}
