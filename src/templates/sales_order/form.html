{% load django_bootstrap5 %}
{% load widget_tweaks %}
{% load humanize %}
{% load formatters %}

<div class="modal-header mb-3">
  <h4 class="modal-title">{{ modal_title }}</h4>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form method="post" id="editForm"
      action="{{ form_action }}"
      data-save-url="{{ form_action }}"
      data-delete-url="{% if form.instance.pk %}{% url 'sales_order:delete' form.instance.pk %}{% endif %}">
  {% csrf_token %}

  {# form全体のエラー表示 #}
  {% if formset.non_form_errors %}
    <div class="alert alert-danger">
      {{ formset.non_form_errors|safe }}
    </div>
  {% endif %}

  <div class="row mb-3">
    {# ステータス #}
    <div class="col-md-3">
      <label class="form-label">ステータス</label>
      <p class="form-control-plaintext">{{ form.instance.get_status_code_display }}</p>
    </div>
    {# 受注日 #}
    <div class="col-md-3">
      <label class="form-label">受注日</label>
      <p class="form-control-plaintext">{{ form.instance.sales_order_date }}</p>
    </div>
    {# 受注担当者 #}
    <div class="col-md-6">
      <label class="form-label">受注担当者</label>
      <p class="form-control-plaintext">
        {% if form.instance.pk %}
          {{ form.instance.create_user }}
        {% else %}
          {{ request.user }}
        {% endif %}
      </p>
    </div>
    {# 取引先 #}
    <div class="col-md-12">
      <label for="{{ form.partner.id_for_label }}" class="form-label">取引先</label>
      {% if form.partner.errors %}
        {% render_field form.partner class="form-select is-invalid" %}
        <div class="invalid-feedback d-block">
          {{ form.partner.errors|join:", " }}
        </div>
      {% else %}
        {% render_field form.partner class="form-select" %}
      {% endif %}
    </div>
    {# 取引先情報 #}
    <div class="row mb-3">
      <div class="col-md-12">
        <div id="partner-info" class="border rounded p-2 bg-light small text-muted">
          {% if form.instance.partner %}
            {% if form.instance.partner.postal_code %}〒{{ form.instance.partner.postal_code|format_postal }}<br>{% endif %}
            {% if form.instance.partner.state %}住所: {{ form.instance.partner.state }}{{ form.instance.partner.city }}{{ form.instance.partner.address }}{{ form.instance.partner.address2 }}<br>{% endif %}
            {% if form.instance.partner.contact_name %}担当者: {{ form.instance.partner.contact_name }}<br>{% endif %}
            {% if form.instance.partner.tel_number %}TEL: {{ form.instance.partner.tel_number|format_tel }}<br>{% endif %}
            {% if form.instance.partner.email %}Email: {{ form.instance.partner.email }}{% endif %}
          {% else %}
            取引先を選択すると情報が表示されます
          {% endif %}
        </div>
      </div>
    </div>

    {# 備考 #}
    <div class="col-md-12">
      <label for="{{ form.remarks.id_for_label }}" class="form-label">備考</label>
      {% render_field form.remarks class="form-control" rows="3" %}
      {% if form.remarks.errors %}
        <div class="text-danger small">{{ form.remarks.errors }}</div>
      {% endif %}
    </div>
  </div>

  {# ======================================= #}
  {# 受注明細 #}
  {# ======================================= #}
  <h5 class="mt-4 mb-2">受注明細</h5>
  {{ formset.management_form }}

  <table class="table table-bordered mb-3 w-100">
    <thead class="table-light text-center fw-bold">
      <tr>
        <th class="w-25">小数点処理</th>
        <th class="w-25">小計</th>
        <th class="w-25">消費税合計</th>
        <th class="w-25">合計金額</th>
      </tr>
    </thead>
    <tbody class="text-center align-middle">
      <tr>
        <td id="rounding-method">{{ form.rounding_method }}</td>
        <td id="subtotal">¥{{ form.instance.subtotal|floatformat:0|intcomma }}</td>
        <td id="tax-total">¥{{ form.instance.tax_total|floatformat:0|intcomma }}</td>
        <td id="grand-total" class="bg-warning">¥{{ form.instance.grand_total|floatformat:0|intcomma }}</td>
      </tr>
    </tbody>
  </table>


  {# 明細行追加ボタン #}
  <div class="text-start mt-2 mb-2">
    <button type="button" id="add-row-btn" class="btn btn-outline-primary btn-sm">
      <svg class="icon text-primary" width="16" height="16">
        <use href="#plus-circle"></use>
      </svg>  明細行を追加
    </button>
  </div>

  {# 受注明細テーブル #}
  <div class="table-responsive">
    <table id="detail-table" class="table table-bordered table-sm align-middle text-nowrap">
      <thead class="table-light text-center fw-bold">
        <tr>
          <th class="w-5">No.</th>
          <th class="w-25">商品</th>
          <th class="w-10">数量</th>
          <th class="w-10">単位</th>
          <th class="w-15">単価</th>
          <th class="w-10">税率</th>
          <th class="w-5">税対象外</th>
          <th class="w-20">金額</th>
          <th class="w-5">削除</th>
        </tr>
      </thead>
      <tbody id="detail-body">
        {% for detail_form in formset.forms %}
        <tr class="align-middle {% if detail_form.errors %}table-danger{% endif %}">
          {{ detail_form.id }}
          <td>{{ forloop.counter }}</td>

          {# 商品 #}
          <td>
            {{ detail_form.product }}
            {% if detail_form.product.errors %}
              <div class="text-danger small">
                {{ detail_form.product.errors.as_text|linebreaksbr }}
              </div>
            {% endif %}
          </td>

          {# 数量 #}
          <td>
            {{ detail_form.quantity }}
            {% if detail_form.quantity.errors %}
              <div class="text-danger small">
                {{ detail_form.quantity.errors.as_text|linebreaksbr }}
              </div>
            {% endif %}
          </td>

          {# 単位 #}
          <td class="unit-cell">{{ detail_form.instance.product.unit }}</td>

          {# 単価 #}
          <td>
            {{ detail_form.billing_unit_price }}
            {% if detail_form.billing_unit_price.errors %}
              <div class="text-danger small">
                {{ detail_form.billing_unit_price.errors.as_text|linebreaksbr }}
              </div>
            {% endif %}
          </td>

          <td>{{ detail_form.tax_rate }}</td>
          <td class="text-center">{{ detail_form.is_tax_exempt }}</td>
          <td class="text-end amount">{{ detail_form.instance.amount|intcomma }}</td>

          <td class="text-center">
            {% render_field detail_form.DELETE class="form-check-input d-none" %}
            <button type="button" class="btn btn-outline-danger btn-sm delete-row-btn">
              <svg class="icon" width="16" height="16">
                <use href="#trash"></use>
              </svg>
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {# 明細行追加テンプレート #}
    <template id="empty-form-template">
      <tr class="align-middle">
        {{ formset.empty_form.id }}
        <td></td>
        <td>{{ formset.empty_form.product }}</td>
        <td>{{ formset.empty_form.quantity }}</td>
        <td class="unit-cell"></td>
        <td>{{ formset.empty_form.billing_unit_price }}</td>
        <td>{{ formset.empty_form.tax_rate }}</td>
        <td class="text-center">{{ formset.empty_form.is_tax_exempt }}</td>
        <td class="text-end amount"></td>
        <td class="text-center">
          <input type="checkbox"
                name="{{ formset.prefix }}-__prefix__-DELETE"
                id="id_{{ formset.prefix }}-__prefix__-DELETE"
                class="form-check-input d-none">
          <button type="button" class="btn btn-outline-danger btn-sm delete-row-btn">
            <svg class="icon" width="16" height="16">
              <use href="#trash"></use>
            </svg>
          </button>
        </td>
      </tr>
    </template>
  </div>

  {# フッターボタン #}
  <div class="d-flex justify-content-end gap-2 mt-3">
    <input type="hidden" name="action_type" id="actionTypeField" value="">
    <button type="submit" class="btn btn-primary" onclick="document.getElementById('actionTypeField').value='DRAFT'">
      下書き保存
    </button>
    <button type="submit" class="btn btn-success" onclick="document.getElementById('actionTypeField').value='SUBMITTED'">
      提出
    </button>
    {% if is_update %}
      <form method="post" action="{% url 'sales_order:delete' pk=form.instance.pk %}" onsubmit="return confirm('本当に削除してよろしいですか？');">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">削除</button>
      </form>
    {% endif %}
  </div>
</form>
