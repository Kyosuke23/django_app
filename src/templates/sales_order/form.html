{% load django_bootstrap5 %}
{% load widget_tweaks %}
{% load humanize %}

<div class="modal-header mb-3">
  <h4 class="modal-title">{{ modal_title }}</h4>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form method="post" id="salesOrderForm" action="{{ form_action }}">
  {% csrf_token %}
  <div class="mb-3">
    <label class="form-label">ステータス</label>
    <p class="form-control-plaintext">{{ form.instance.get_status_code_display }}</p>
  </div>
  {% bootstrap_form form %}

  <h5 class="mt-4 mb-2">受注明細</h5>
  {{ formset.management_form }}

  <table class="table table-bordered mb-3 w-100">
    <thead class="table-light text-center fw-bold">
      <tr>
        <th class="w-33">小計</th>
        <th class="w-33">消費税合計</th>
        <th class="w-34">合計金額</th>
      </tr>
    </thead>
    <tbody class="text-center">
      <tr>
        <td id="subtotal">¥{{ form.instance.subtotal|floatformat:0|intcomma }}</td>
        <td id="tax-total">¥{{ form.instance.tax_total|floatformat:0|intcomma }}</td>
        <td id="grand-total" class="bg-warning">¥{{ form.instance.grand_total|floatformat:0|intcomma }}</td>
      </tr>
    </tbody>
  </table>
  <div class="">
    <table class="table table-bordered table-sm align-middle text-nowrap table-responsive">
      <thead class="table-light">
        <tr>
          <th class="w-5">No.</th>
          <th class="w-25">商品</th>
          <th class="w-10">数量</th>
          <th class="w-10">単位</th>
          <th class="w-15">単価</th>
          <th class="w-10">消費税率</th>
          <th class="w-5">税対象外</th>
          <th class="w-20">金額</th>
          <th class="w-5">削除</th>
        </tr>
      </thead>
      <tbody>
        {% for detail_form in formset %}
        <tr>
          {{ detail_form.id }}
          <td>{{ forloop.counter }}</td>
          <td>{{ detail_form.product }}</td>
          <td>{{ detail_form.quantity }}</td>
          <td>{{ detail_form.initial.unit }}</td>
          <td>{{ detail_form.billing_unit_price }}</td>
          <td>{{ detail_form.tax_rate }}</td>
          <td class="text-center">{{ detail_form.is_tax_exempt }}</td>
          <td class="text-end amount">
            {{ detail_form.instance.amount|intcomma }}
          </td>
          {% if is_update %}
            <td class="text-center">
              <div class="form-check d-flex justify-content-center">
                {% render_field detail_form.DELETE class="form-check-input" %}
              </div>
            </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-3">
    <input type="hidden" name="action_type" id="actionTypeField" value="">
    <button type="submit" class="btn btn-primary"
            onclick="document.getElementById('actionTypeField').value='draft'">
      下書き保存
    </button>
    <button type="submit" class="btn btn-success"
            onclick="document.getElementById('actionTypeField').value='submit'">
      提出
    </button>
    {% if is_update %}
      <form method="post" action="{% url 'sales_order:delete' pk=form.instance.pk %}"
            onsubmit="return confirm('本当に削除してよろしいですか？');">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">削除</button>
      </form>
    {% endif %}
  </div>

</form>
