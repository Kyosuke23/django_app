{% load django_bootstrap5 %}
{% load widget_tweaks %}
{% load humanize %}
{% load formatters %}

<div class="modal-header mb-3">
  <h4 class="modal-title">{{ modal_title }}</h4>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form method="post" id="salesOrderForm" action="{{ form_action }}">
  {% csrf_token %}
  <div class="row mb-3">
    <!-- ステータス -->
    <div class="col-md-3">
      <label class="form-label">ステータス</label>
      <p class="form-control-plaintext">{{ form.instance.get_status_code_display }}</p>
    </div>

    <!-- 受注日 -->
    <div class="col-md-3">
      <label for="{{ form.sales_order_date.id_for_label }}" class="form-label">受注日</label>
      <p class="form-control-plaintext">{{ form.instance.sales_order_date }}</p>
    </div>

    <!-- 受注担当者 -->
    <div class="col-md-6">
      <label class="form-label">受注担当者</label>
      <p class="form-control-plaintext">
        {% if form.instance.pk %}
          {{ form.instance.create_user }}
        {% else %}
          {{ request.user }}
        {% endif %}
      </p>
    </div>

    <!-- 取引先 -->
    <div class="col-md-12">
      <label for="{{ form.partner.id_for_label }}" class="form-label">取引先</label>
      {% render_field form.partner class="form-select" %}
    </div>

    <!-- 取引先情報の表示領域 -->
    <div class="row mb-3">
      <div class="col-md-12">
        <div id="partner-info" class="border rounded p-2 bg-light small text-muted">
          {% if form.instance.partner %}
            {% if form.instance.partner.postal_code %}〒{{ form.instance.partner.postal_code|format_postal }}<br>{% endif %}
            {% if form.instance.partner.state %}住所: {{ form.instance.partner.state }}{{ form.instance.partner.city }}{{ form.instance.partner.address }}{{ form.instance.partner.address2 }}<br>{% endif %}
            {% if form.instance.partner.contact_name %}担当者: {{ form.instance.partner.contact_name }}<br>{% endif %}
            {% if form.instance.partner.tel_number %}TEL: {{ form.instance.partner.tel_number|format_tel }}<br>{% endif %}
            {% if form.instance.partner.email %}Email: {{ form.instance.partner.email }}{% endif %}
          {% else %}
            取引先を選択すると情報が表示されます
          {% endif %}
        </div>
      </div>
    </div>

    <!-- 備考 -->
    <div class="col-md-12">
      <label for="{{ form.remarks.id_for_label }}" class="form-label">備考</label>
      {% render_field form.remarks class="form-control" rows="3" %}
    </div>
  </div>

  <h5 class="mt-4 mb-2">受注明細</h5>
  {{ formset.management_form }}

  <table class="table table-bordered mb-3 w-100">
    <thead class="table-light text-center fw-bold">
      <tr>
        <th class="w-25">小数点処理</th>
        <th class="w-25">小計</th>
        <th class="w-25">消費税合計</th>
        <th class="w-25">合計金額</th>
      </tr>
    </thead>
    <tbody class="text-center align-middle">
      <tr>
        <td id="rounding-method">{{ form.rounding_method }}</td>
        <td id="subtotal">¥{{ form.instance.subtotal|floatformat:0|intcomma }}</td>
        <td id="tax-total">¥{{ form.instance.tax_total|floatformat:0|intcomma }}</td>
        <td id="grand-total" class="bg-warning">¥{{ form.instance.grand_total|floatformat:0|intcomma }}</td>
      </tr>
    </tbody>
  </table>
  <div class="">
    <table class="table table-bordered table-sm align-middle text-nowrap table-responsive">
      <thead class="table-light">
        <tr>
          <th class="w-5">No.</th>
          <th class="w-25">商品</th>
          <th class="w-10">数量</th>
          <th class="w-10">単位</th>
          <th class="w-15">単価</th>
          <th class="w-10">消費税率</th>
          <th class="w-5">税対象外</th>
          <th class="w-20">金額</th>
          <th class="w-5">削除</th>
        </tr>
      </thead>
      <tbody>
        {% for detail_form in formset %}
        <tr>
          {{ detail_form.id }}
          <td>{{ forloop.counter }}</td>
          <td>{{ detail_form.product }}</td>
          <td>{{ detail_form.quantity }}</td>
          <td class="unit-cell">{{ detail_form.instance.product.unit }}</td>
          <td>{{ detail_form.billing_unit_price }}</td>
          <td>{{ detail_form.tax_rate }}</td>
          <td class="text-center">{{ detail_form.is_tax_exempt }}</td>
          <td class="text-end amount">
            {{ detail_form.instance.amount|intcomma }}
          </td>
          {% if is_update %}
            <td class="text-center">
              <div class="form-check d-flex justify-content-center">
                {% render_field detail_form.DELETE class="form-check-input" %}
              </div>
            </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-3">
    <input type="hidden" name="action_type" id="actionTypeField" value="">
    <button type="submit" class="btn btn-primary"
            onclick="document.getElementById('actionTypeField').value='draft'">
      下書き保存
    </button>
    <button type="submit" class="btn btn-success"
            onclick="document.getElementById('actionTypeField').value='submit'">
      提出
    </button>
    {% if is_update %}
      <form method="post" action="{% url 'sales_order:delete' pk=form.instance.pk %}"
            onsubmit="return confirm('本当に削除してよろしいですか？');">
        {% csrf_token %}
        <button type="submit" class="btn btn-danger">削除</button>
      </form>
    {% endif %}
  </div>

</form>
