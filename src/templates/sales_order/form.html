{% load django_bootstrap5 %}
{% load widget_tweaks %}
{% load humanize %}
{% load formatters %}

<div class="modal-header mb-2">
  <h4 class="modal-title">{{ modal_title }}</h4>
  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>

<form method="post" id="editForm" action="{{ form_action }}" data-save-url="{{ form_action }}" data-order-id="{{ form.instance.pk }}"
      data-delete-url="{% if form.instance.pk %}{% url 'sales_order:delete' form.instance.pk %}{% endif %}">
  {% csrf_token %}

  {# form全体のエラー表示 #}
  {% if formset.non_form_errors %}
    <div class="alert alert-danger">
      {{ formset.non_form_errors|safe }}
    </div>
  {% endif %}

  <div class="row mb-2">
    {# ステータス #}
    <div class="col-md-12">
      <label class="form-label">ステータス</label>
      <p class="form-control-plaintext">{{ form.instance.get_status_code_display }}</p>
    </div>
    {# 受注日 #}
    <div class="col-md-3">
      <label class="form-label">受注日</label>
      {% render_field form.sales_order_date class="form-control" %}
      {% if form.sales_order_date.help_text %}
        <div class="form-text text-muted small">{{ form.sales_order_date.help_text }}</div>
      {% endif %}
    </div>
    {# 受注担当者 #}
    <div class="col-md-9">
      <label class="form-label">受注担当者</label>
      {% render_field form.assignee class="form-control" %}
      {% if form.assignee.help_text %}
        <div class="form-text text-muted small">{{ form.assignee.help_text }}</div>
      {% endif %}
    </div>
    {# 納入予定日 #}
    <div class="col-md-3 mb-2">
      <label class="form-label">納入予定日</label>
      {% render_field form.delivery_due_date class="form-control" %}
      {% if form.delivery_due_date.help_text %}
        <div class="form-text text-muted small">{{ form.delivery_due_date.help_text }}</div>
      {% endif %}
    </div>
    {# 納入場所 #}
    <div class="col-md-9">
      <label class="form-label">納入場所</label>
      {% render_field form.delivery_place class="form-control" %}
      {% if form.delivery_place.help_text %}
        <div class="form-text text-muted small">{{ form.delivery_place.help_text }}</div>
      {% endif %}
    </div>
    {# 取引先 #}
    <div class="col-md-12 mb-2">
      <label for="{{ form.partner.id_for_label }}" class="form-label">取引先</label>
      {% if form.partner.errors %}
        {% render_field form.partner class="form-select is-invalid" %}
        <div class="invalid-feedback d-block">
          {{ form.partner.errors|join:", " }}
        </div>
      {% else %}
        {% render_field form.partner class="form-select" %}
      {% endif %}
    </div>
    {# 取引先情報 #}
    <div class="row mb-2">
      <div class="col-md-12">
        <div id="partner-info" class="border rounded p-2 bg-light small text-muted">
          {% if form.instance.partner %}
            {% if form.instance.partner.postal_code %}〒{{ form.instance.partner.postal_code|format_postal }}<br>{% endif %}
            {% if form.instance.partner.state %}住所: {{ form.instance.partner.state }}{{ form.instance.partner.city }}{{ form.instance.partner.address }}{{ form.instance.partner.address2 }}<br>{% endif %}
            {% if form.instance.partner.contact_name %}担当者: {{ form.instance.partner.contact_name }}<br>{% endif %}
            {% if form.instance.partner.tel_number %}TEL: {{ form.instance.partner.tel_number|format_tel }}<br>{% endif %}
            {% if form.instance.partner.email %}Email: {{ form.instance.partner.email }}{% endif %}
          {% else %}
            取引先を選択すると情報が表示されます
          {% endif %}
        </div>
      </div>
    </div>
    {# 備考 #}
    <div class="col-md-12 mb-2">
      <label for="{{ form.remarks.id_for_label }}" class="form-label">備考</label>
      {% render_field form.remarks class="form-control" rows="3" %}
      {% if form.remarks.help_text %}
        <div class="form-text text-muted small">{{ form.remarks.help_text }}</div>
      {% endif %}
      {% if form.remarks.errors %}
        <div class="text-danger small">{{ form.remarks.errors }}</div>
      {% endif %}
    </div>
<div class="border border-danger-subtle rounded p-3 bg-danger bg-opacity-10 mt-4 mb-3">
  <h6 class="text-danger fw-bold mb-3">
    社内専用コメント欄
    <small class="text-muted ms-2">(見積書・注文書には印字されません)</small>
  </h6>
  <div class="row">
    <div class="col-md-3 mb-2">
      <label class="form-label">見積書コメント（承認者）</label>
      {% render_field form.quotation_manager_comment class="form-control internal-comment" rows="3" %}
      {% if form.quotation_manager_comment.help_text %}
        <div class="form-text text-muted small">{{ form.quotation_manager_comment.help_text }}</div>
      {% endif %}
    </div>
    <div class="col-md-3 mb-2">
      <label class="form-label">見積書コメント（顧客）</label>
      {% render_field form.quotation_customer_comment class="form-control internal-comment" rows="3" %}
      {% if form.quotation_customer_comment.help_text %}
        <div class="form-text text-muted small">{{ form.quotation_customer_comment.help_text }}</div>
      {% endif %}
    </div>
    <div class="col-md-3 mb-2">
      <label class="form-label">注文書コメント（承認者）</label>
      {% render_field form.order_manager_comment class="form-control internal-comment" rows="3" %}
      {% if form.order_manager_comment.help_text %}
        <div class="form-text text-muted small">{{ form.order_manager_comment.help_text }}</div>
      {% endif %}
    </div>
    <div class="col-md-3 mb-2">
      <label class="form-label">注文書コメント（顧客）</label>
      {% render_field form.order_customer_comment class="form-control internal-comment" rows="3" %}
      {% if form.order_customer_comment.help_text %}
        <div class="form-text text-muted small">{{ form.order_customer_comment.help_text }}</div>
      {% endif %}
    </div>
  </div>
</div>
    {# 参照ユーザー #}
    <div class="col-md-6">
      <label class="form-label">参照ユーザー</label>
      {% if form.reference_users.errors %}
        {% render_field form.reference_users class="form-select is-invalid" %}
        <div class="invalid-feedback d-block">
          {{ form.reference_users.errors|join:", " }}
        </div>
      {% else %}
        {% render_field form.reference_users class="form-select" %}
      {% endif %}
    </div>
    {# 参照ユーザーグループ #}
    <div class="col-md-6">
      <label class="form-label">参照グループ</label>
      {% if form.reference_groups.errors %}
        {% render_field form.reference_groups class="form-select is-invalid" %}
        <div class="invalid-feedback d-block">
          {{ form.reference_groups.errors|join:", " }}
        </div>
      {% else %}
        {% render_field form.reference_groups class="form-select" %}
      {% endif %}
    </div>
  </div>

  {# ======================================= #}
  {# 受注明細 #}
  {# ======================================= #}
  <hr>
  <h5 class="mt-4 mb-2">受注明細</h5>
  {{ formset.management_form }}
  {# 小計エリア #}
  <table class="table table-bordered mb-3 w-100">
    <thead class="table-light text-center fw-bold">
      <tr>
        <th class="w-25">小数点処理</th>
        <th class="w-25">小計</th>
        <th class="w-25">消費税合計</th>
        <th class="w-25">合計金額</th>
      </tr>
    </thead>
    <tbody class="text-center align-middle">
      <tr>
        <td id="rounding-method">{{ form.rounding_method }}</td>
        <td id="subtotal">¥{{ form.instance.subtotal|floatformat:0|intcomma }}</td>
        <td id="tax-total">¥{{ form.instance.tax_total|floatformat:0|intcomma }}</td>
        <td id="grand-total" class="bg-warning bg-opacity-25">¥{{ form.instance.grand_total|floatformat:0|intcomma }}</td>
      </tr>
    </tbody>
  </table>

  {# 明細行追加ボタン #}
  {% if form.instance.status_code == 'DRAFT' %}
  <div class="text-start mt-2 mb-2">
    <button type="button" id="add-row-btn" class="btn btn-outline-primary btn-sm">
      <i class="bi bi-plus-circle me-1"></i>明細行を追加
    </button>
  </div>
  {% endif %}

  {# 受注明細テーブル #}
  <div class="table-responsive">
    <table id="detail-table" class="table table-bordered table-sm align-middle text-nowrap">
      <thead class="table-light text-center fw-bold">
        <tr>
          <th class="w-5">No.</th>
          <th class="w-25">商品</th>
          <th class="w-10">数量</th>
          <th class="w-10">単位</th>
          <th class="w-15">単価</th>
          <th class="w-10">税率</th>
          <th class="w-5">税対象外</th>
          <th class="w-20">金額</th>
          <th class="w-5">削除</th>
        </tr>
      </thead>
      <tbody id="detail-body">
        {% for detail_form in formset.forms %}
        <tr class="align-middle {% if detail_form.errors %}table-danger{% endif %}">
          {{ detail_form.id }}
          <td>{{ forloop.counter }}</td>
          {# 商品 #}
          <td>
            {{ detail_form.product }}
            {% if detail_form.product.errors %}
              <div class="text-danger small">
                {{ detail_form.product.errors.as_text|linebreaksbr }}
              </div>
            {% endif %}
          </td>
          {# 数量 #}
          <td>
            {{ detail_form.quantity }}
            {% if detail_form.quantity.errors %}
              <div class="text-danger small">
                {{ detail_form.quantity.errors.as_text|linebreaksbr }}
              </div>
            {% endif %}
          </td>
          {# 単位 #}
          <td class="unit-cell">{{ detail_form.instance.product.unit }}</td>
          {# 単価 #}
          <td>
            {{ detail_form.billing_unit_price }}
            {% if detail_form.billing_unit_price.errors %}
              <div class="text-danger small">
                {{ detail_form.billing_unit_price.errors.as_text|linebreaksbr }}
              </div>
            {% endif %}
          </td>
          <td>{{ detail_form.tax_rate }}</td>
          <td class="text-center">{{ detail_form.is_tax_exempt }}</td>
          <td class="text-end amount">{{ detail_form.instance.amount|intcomma }}</td>
          {% if is_editable %}
          <td class="text-center">
            {% render_field detail_form.DELETE class="form-check-input d-none" %}
            <button type="button" class="btn btn-outline-danger btn-sm delete-row-btn">
              <svg class="icon" width="16" height="16">
                <use href="#trash"></use>
              </svg>
            </button>
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>

    {# 明細行追加テンプレート #}
    <template id="empty-form-template">
      <tr class="align-middle">
        {{ formset.empty_form.id }}
        <td></td>
        <td>{{ formset.empty_form.product }}</td>
        <td>{{ formset.empty_form.quantity }}</td>
        <td class="unit-cell"></td>
        <td>{{ formset.empty_form.billing_unit_price }}</td>
        <td>{{ formset.empty_form.tax_rate }}</td>
        <td class="text-center">{{ formset.empty_form.is_tax_exempt }}</td>
        <td class="text-end amount"></td>
        <td class="text-center">
          <input type="checkbox"
                name="{{ formset.prefix }}-__prefix__-DELETE"
                id="id_{{ formset.prefix }}-__prefix__-DELETE"
                class="form-check-input d-none">
          <button type="button" class="btn btn-outline-danger btn-sm delete-row-btn">
            <svg class="icon" width="16" height="16">
              <use href="#trash"></use>
            </svg>
          </button>
        </td>
      </tr>
    </template>
  </div>
  {# フッターボタン #}
  {% if is_submittable %}
    <div class="d-flex justify-content-between gap-2 mt-3">
      {# 見積書・注文書確認ボタン #}
      <div>
        {% if form.instance.status_code in 'DRAFT SUBMITTED' %}
          <button type="submit" class="btn btn-primary" data-action="OUTPUT_QUOTATION_IN">見積書確認</button>
        {% endif %}
        {% if form.instance.status_code in 'ORDER_SUBMITTED QUOTATION_CONFIRMED' %}
          <button type="submit" class="btn btn-primary" data-action="OUTPUT_ORDER_IN">注文書確認</button>
        {% endif %}
      </div>
      <div class="d-flex gap-2">
        {# 見積書：仮作成 #}
        {% if form.instance.status_code == 'DRAFT' %}
          <button type="submit" class="btn btn-primary" data-action="DRAFT">下書き保存</button>
          <button type="submit" class="btn btn-success" data-action="QUOTATION_SUBMITTED">提出</button>
          {% if is_update %}
            <form method="post" action="{% url 'sales_order:delete' pk=form.instance.pk %}"
                  onsubmit="return confirm('本当に削除してよろしいですか？');">
              {% csrf_token %}
              <button type="submit" class="btn btn-danger" data-action="delete">削除</button>
            </form>
          {% endif %}
        {% endif %}
        {# 見積書：提出済 #}
        {% if form.instance.status_code == 'QUOTATION_SUBMITTED' %}
          <button type="submit" class="btn btn-success" data-action="QUOTATION_APPROVED">承認</button>
          <button type="submit" class="btn btn-danger" data-action="QUOTATION_REJECTED_IN">却下</button>
        {% endif %}
        {# 見積書：社内却下 #}
        {% if form.instance.status_code == 'QUOTATION_REJECTED_IN' %}
          <button type="submit" class="btn btn-primary" data-action="QUOTATION_RETAKE">再編集</button>
          <form method="post" action="{% url 'sales_order:delete' pk=form.instance.pk %}"
                onsubmit="return confirm('本当に削除してよろしいですか？');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger" data-action="delete">削除</button>
          </form>
        {% endif %}
        {# 見積書：顧客却下 #}
        {% if form.instance.status_code == 'QUOTATION_REJECTED_OUT' %}
          <button type="submit" class="btn btn-primary" data-action="QUOTATION_RETAKE">再編集</button>
          <form method="post" action="{% url 'sales_order:delete' pk=form.instance.pk %}"
                onsubmit="return confirm('本当に削除してよろしいですか？');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger" data-action="delete">削除</button>
          </form>
        {% endif %}
        {# 見積書：顧客承認済 #}
        {% if form.instance.status_code == 'QUOTATION_CONFIRMED' %}
          <button type="submit" class="btn btn-success" data-action="ORDER_SUBMITTED">注文書提出</button>
          <button type="submit" class="btn btn-warning" data-action="CANCELED">キャンセル</button>
        {% endif %}
        {# 注文書：提出済 #}
        {% if form.instance.status_code == 'ORDER_SUBMITTED' %}
          <button type="submit" class="btn btn-success" data-action="ORDER_APPROVED">承認</button>
          <button type="submit" class="btn btn-danger" data-action="ORDER_REJECTED_IN">却下</button>
        {% endif %}
        {# 注文書：社内却下 #}
        {% if form.instance.status_code == 'ORDER_REJECTED_IN' %}
          <button type="submit" class="btn btn-primary" data-action="ORDER_RETAKE">再編集</button>
          <form method="post" action="{% url 'sales_order:delete' pk=form.instance.pk %}"
                onsubmit="return confirm('本当に削除してよろしいですか？');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger" data-action="delete">削除</button>
          </form>
        {% endif %}
        {# 注文書：顧客却下 #}
        {% if form.instance.status_code == 'ORDER_REJECTED_OUT' %}
          <button type="submit" class="btn btn-primary" data-action="ORDER_RETAKE">再編集</button>
          <form method="post" action="{% url 'sales_order:delete' pk=form.instance.pk %}"
                onsubmit="return confirm('本当に削除してよろしいですか？');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger" data-action="delete">削除</button>
          </form>
        {% endif %}
      </div>
    </div>
  {% else %}
    <div class="alert alert-secondary text-center w-100 mb-0">
      この受注は編集できません。
    </div>
  {% endif %}
  </div>
</form>
